name: Shift traffic to BLUE (manual)

on:
  workflow_dispatch:
    inputs:
      percent_to_blue:
        description: 'Percentage of traffic to route to BLUE'
        required: true

jobs:
  shift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Make scripts executable
        run: chmod +x scripts/*.sh
      - name: Shift traffic
        run: |
          mkdir -p logs run
          ./scripts/shift_traffic.sh ${{ github.event.inputs.percent_to_blue }} 100 > logs/shift_run.log || true
      - name: Upload shift logs
        uses: actions/upload-artifact@v4
        with:
          name: shift-logs
          path: logs/shift_run.log
      - name: Publish shift summary to job summary
        if: always()
        run: |
          SUMMARY_LINE=$(grep '^SUMMARY:' logs/shift_run.log | tail -n1 || true)
          if [ -z "$SUMMARY_LINE" ]; then
            echo "**Shift summary:** (no summary found)" >> "$GITHUB_STEP_SUMMARY"
          else
            # parse into fields like requested=100 blue=33 green=67
            REQUESTED=$(echo "$SUMMARY_LINE" | sed -E 's/.*requested=([0-9]+).*/\1/')
            BLUE=$(echo "$SUMMARY_LINE" | sed -E 's/.*blue=([0-9]+).*/\1/')
            GREEN=$(echo "$SUMMARY_LINE" | sed -E 's/.*green=([0-9]+).*/\1/')
            echo "## Shift traffic summary" >> "$GITHUB_STEP_SUMMARY"
            echo '' >> "$GITHUB_STEP_SUMMARY"
            echo "| requested | blue | green |" >> "$GITHUB_STEP_SUMMARY"
            echo "|---:|---:|---:|" >> "$GITHUB_STEP_SUMMARY"
            echo "| $REQUESTED | $BLUE | $GREEN |" >> "$GITHUB_STEP_SUMMARY"
            echo '' >> "$GITHUB_STEP_SUMMARY"
            echo 'Raw summary:' >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "$SUMMARY_LINE" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          fi
